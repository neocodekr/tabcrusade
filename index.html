<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Link: AdventureStory | Mini Dapp</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://static.kaiawallet.io/js/dapp-portal-sdk.js"></script>
    <script src="kaia.js"></script>
    <script src="util.js"></script>
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=360 height=640 tabindex="-1"></canvas>
    </div>
    <script> 
      if ( liff ) {
        ConnectLiff();
      } else {
        LoadApp();
      }
  window.ConnectLiff = async function() {
  
      liff.init({ liffId: '2007317092-WoJBR1mY',})
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();

          } else {
            const idToken = liff.getIDToken();
            console.log('getIDToken = ' + idToken);
            const accessToken = liff.getAccessToken();
            console.log('accessToken = ' + accessToken);
            console.log('liff lan = ' + liff.getAppLanguage());
            console.log('liff profile' + liff.getProfile());
            OnLoadUnity();
          }
        
        })
        .catch((err) => {
          // Error happens during initialization
          console.log(err.code, err.message);
        });
    }
  function LoadApp() {
    var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
          createUnityInstance(canvas, config, (progress) => {
                }).then((unityInstance) => {
                  myGameInstance = unityInstance;
                  myGameInstance.SendMessage('Web3Manager', 'OnCountry', getLanguage());
                  liff.getProfile().then(profile => {
                    let profile = JSON.stringify(profile, null, 2);
                    myGameInstance.SendMessage('Web3Manager', 'OnCountry', getLanguage());
                    console.log('liff profile (stringified):', JSON.stringify(profile, null, 2));
                  });
                }).catch((message) => {
                  alert(message);
                });
              };
       document.body.appendChild(script);
  }
    var unityCanvas = document.querySelector("#unity-canvas");

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/build.loader.js";
      var config = {
        dataUrl: buildUrl + "/build.data",
        frameworkUrl: buildUrl + "/build.framework.js",
        codeUrl: buildUrl + "/build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "ButterSoft",
        productName: "Link",
        productVersion: "1.0.1",
      };
      console.log('os = ' + getOS());
      SetScreen();
      function SetScreen() {
              if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                  var meta = document.createElement('meta');
                  meta.name = 'viewport';
                  meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                  document.head.appendChild(meta);

                  var canvas = unityCanvas;
                  canvas.style.width = "100%";
                  canvas.style.height = "100%";
                  canvas.style.position = "fixed";
                  canvas.style.left = "0";
                  canvas.style.top = "0";
                  document.body.style.margin = "0";
                  document.body.style.overflow = "hidden";

                  /*if (Telegram.WebView) {
                      Telegram.WebView.onEvent('viewport_changed', function (eventType, eventData) {
                          const vp = window.visualViewport;
                          if (eventData.is_state_stable) {
                              if ((vp.height - vp.offsetTop) < eventData.height) {
                                  window.scrollTo({ top: 0, behavior: 'smooth' });
                                  unityCanvas.style.width = "100%";
                                  unityCanvas.style.height = "100%";
                                  unityCanvas.style.position = "fixed";
                              }
                          }
                      });
                    
                  }  */
              } else {
                  function centerElement() {
                      var originalWidth = 1080;
                      var originalHeight = 2400;
                      var aspectRatio = originalWidth / originalHeight;

                      var windowWidth = window.innerWidth;
                      var windowHeight = window.innerHeight;

                      var canvas = unityCanvas;
                      if (windowWidth / windowHeight > aspectRatio) {
                          canvas.style.width = windowHeight * aspectRatio + "px";
                          canvas.style.height = windowHeight + "px";
                      } else {
                          canvas.style.width = windowWidth + "px";
                          canvas.style.height = windowWidth / aspectRatio + "px";
                      }

                      canvas.style.position = "fixed";
                      canvas.style.top = "50%";
                      canvas.style.left = "50%";
                      canvas.style.transform = "translate(-50%, -50%)";
                  }

                  centerElement();
                  window.addEventListener("resize", centerElement);
              }
          }
    

    </script>
  </body>
</html>
